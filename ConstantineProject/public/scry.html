<!DOCTYPE html>
<html>

<head>

	<title>Scry</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="./js/leaflet-src.js"></script>
	<script src="./js/leaflet-sidebar.js"></script>
	<script src="./js/timeline.js"></script>

	<link rel="stylesheet" href="./css/leaflet.css" />
	<link rel="stylesheet" href="./css/leaflet-sidebar.css" />
	<link rel="stylesheet" href="./css/timeline.css" />

	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="shortcut icon" type="image/x-icon" href="./images/coin.s.png" />

	<style>
		html,
		body {
			height: 100%;
			margin: 0;
		}

		#map {
			width: 100%;
			height: 93%;
		}

		.leaflet-container {
			background-color: rgb(176, 220, 242);
		}
	</style>


</head>

<body>
	<div id="sidebar" class="sidebar collapsed">
		<!-- Nav tabs -->
		<div class="sidebar-tabs">
			<ul role="tablist">
				<li><a href="#home" role="tab"><img src="./images/coin.s.png" height = "40px" width = "40px"></img></a></li>
				<li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
				<li><a href="#somethingelse" role="tab"><i class="fa fa-envelope"></i></a></li>
			</ul>

			<ul role="tablist">
				<li><a href="#add" role="tab"><i class="fa fa-plus-circle"></i></a></li>
				<li><a href="#edit" role="tab"><i class="fa fa-pencil"></i></a></li>
				<li><a href="#linkAgents" role="tab"><i class="fa fa-exchange"></i></a></li>
				<li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
			</ul>
		</div>

		<!-- Tab panes -->
		<div class="sidebar-content">
			<div class="sidebar-pane" id="home">
				<h1 class="sidebar-header">
							  <div class ="shader"><b>CONSTANTINE</b></div>
	              <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
	          </h1>
				<div class="paper">
					<p class="lorem">
						Constantine: From Rome to Byzantium is leaflet-based web application which showcases an interactive historical narrative. Constantine is built with Scry, a technology which visualizes the causal linkage between historical events, which can then be explored
						at the discretion of the user.
					</p>
				</div>
			</div>

			<div class="sidebar-pane" id="profile">
				<h1 class="sidebar-header">
							<div class = "shader">Profile</div>
							<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
						</h1>
				<div class="paper">
					<p>Information about your profile goes here</p>
				</div>
			</div>

			<div class="sidebar-pane" id="somethingelse">
				<h1 class="sidebar-header">
							<div class = "shader">Something Else</div>
							<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
						</h1>
				<div class="paper">
					<p>Something else can go here</p>
				</div>
			</div>

			<div class="sidebar-pane" id="add">
				<h1 class="sidebar-header">
							<div class = "shader">Create</div>
							<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
						</h1>
				<div class="paper">

					<p>Create new historical agent</p>
					</br></br>
					<!--h3>Create new historical agent:</h3-->

				<div id="createAgentFormDiv"></div>
				<template>
				<form action="createAgent.datastore" method="post" id="createAgentForm">
					<label>Name:
							<input type="text" name="name" id="name" placeholder="Venice"/>
					</label>
					</br></br>
					<label>Type:
							<!--input type="checkbox" name="check" onclick="onlyOne(this)" id="city">City</input>
							<input type="checkbox" name="check" onclick="onlyOne(this)" id="person">Person</input>
							<input type="checkbox" name="check" onclick="onlyOne(this)" id="event">Event</input-->
							<select name="type" id="type" size="3">
									<option value="city">City</option>
									<option value="person">Person</option>
									<option value="event">Event</option>
							</select>
					</label>
					</br></br>
					<label>Year Range:
							<!--/br-->
							<input type="number" name="yearRange1" id="yearRange1" placeholder="272" style="width:50px;"/>
							-
							<input type="number" name="yearRange2" id="yearRange2" placeholder="337" style="width:50px;"/>
					</label>
					</br></br>
					<label>Coordinates:
							<!--/br-->
							<input type="number" step="0.001" name="coordinates1" id="coordinates1" placeholder="45" style="width:50px;"/>
							-
							<input type="number" step="0.001" name="coordinates2" id="coordinates2" placeholder="15" style="width:50px;"/>
					</label>
					</br></br>
					<label>Description:
							<!--input type="text" name="description" id="description" value="Flavia Maxima Fausta (289â€“326) was a Roman Empress, daughter of the Roman Emperor Maximianus."/-->
							<textarea rows="2" cols="40" name="description" id="description" placeholder="Venice is a city in northeastern Italy and the capital of the Veneto region."></textarea>
							Attribution:<input type="text" name="description.att" id="description.att" placeholder="https://en.wikipedia.org/wiki/Venice"/>
					</label>
					</br></br>
					<label>Picture:
							<input type="file" name="picture" id="picture"/>
							</br>
							Attribution:<input type="text" name="picture.att" id="picture.att" placeholder="https://en.wikipedia.org/wiki/Venice#/media/File:Collage_Venezia.jpg"/>
					</label>
					</br></br>
					<label>Icon:
							<input type="file" name="icon" id="icon"/>
					</label>
					</br></br>


				</form>
				</template>
				<input type="submit" id="createAgentButton" value="Create Historical Agent"  form="createAgentForm">


					<!--strong><p>Create new historical agent.</p></strong>
					<label>Agent's Name:
							<input type="text" name="name" id="name" value="Fausta"/>
					</label>
					</br></br>
					<label>Type:
							<input type="text" name="type" id="type" value="person"/>
					</label>
					</br></br>
					<label>Year Range:
							</br>
							<input type="number" name="yearRange1" id="yearRange1" value="272"/>
							-
							<input type="number" name="yearRange1" id="yearRange1" value="337"/>
					</label-->

				</div>
			</div>



			<div class="sidebar-pane" id="edit">
					<h1 class="sidebar-header">
								<div class = "shader">Edit</div>
								<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
							</h1>
					<div class="paper">
						<p>Edit existing historical agents</p>
						</br></br>
						<!--h3>Create new historical agent:</h3-->
						<!--label>Name:
								<input type="text" name="name" id="name" value="Venice"/>
						</label-->
						<!--/br></br-->
						<label>Type:
								<input type="checkbox" name="check" onclick="onlyOne(this)" id="city">City</input>
								<input type="checkbox" name="check" onclick="onlyOne(this)" id="person">Person</input>
								<input type="checkbox" name="check" onclick="onlyOne(this)" id="event">Event</input>
								</br></br>
								<select size="5" id="agentsList">
								</select>
						</label>
						</br>
						<p id="edit.name"></p>
						<span>(ID: </span><span id="edit.id"></span><span> )</span>


						<div id="editAgentFormDiv"></div>

						<!--div class="paper"><iframe id = "editAgentFrame" src="./agents/edit-agent.html"></iframe></div-->

						<button id="updateAgentButton" type="button"><strong>Update Historical Agent</strong></button>
						<!--input type="submit" id="updateAgentButton" value="Update Historical Agent"  form="updateAgentForm"-->
						<button id="deleteAgentButton" type="button"><strong>Delete Historical Agent</strong></button>
					</br></br></br></br></br></br>





					</div>
				</div>



			<div class="sidebar-pane" id="linkAgents">
				<h1 class="sidebar-header">
							<div class = "shader">Link</div>
							<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
						</h1>
				<div class="paper">
					<p>Add a link between two agents</p>
					<p>(Feature in development)</p>
					<button id="linkAgentsButton" type="button"><strong>Link Selected Agents</strong></button>
				</div>
			</div>
			<div class="sidebar-pane" id="settings">
				<h1 class="sidebar-header">
							<div class = "shader">Settings</div>
							<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
						</h1>
				<div class="paper">
					<p>Select your desired settings here</p>
				</div>
			</div>
		</div>
	</div>

	<div id='map' class='sidebar-map'></div>
	<div id='timeline-background' class='timeline-background'>
		<div id = 'timeline-wrapper' class = 'timeline-wrapper'>
			<input type="range" name="time" min="0" max="0" value="0" class="slider" id="slide">
			<div id="bubble-wrapper" class = 'bubble-wrapper'>
				<div id="bubble" class = 'bubble'></div>
			</div>
		</div>
	</div>
	</div>

	<script src="./geo/provinces.js" type="text/javascript"></script>
	<script src="./geo/rivers.js" type="text/javascript"></script>
	<script src="./geo/lakes.js" type="text/javascript"></script>

	<script src="./geo/land.js" type="text/javascript"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<script>




		// Set slide
		var mapPeriod = [267,330];
		var mapYear = mapPeriod[0];
		document.getElementById('slide').min = mapPeriod[0];
		document.getElementById('slide').max = mapPeriod[1];
		document.getElementById('slide').value = mapYear;
		// Set the bounds of the map
		bounds = new L.LatLngBounds(new L.LatLng(20, -50), new L.LatLng(70, 60));

		var map = new L.map('map', {
			maxBounds: bounds,
			maxBoundsViscosity: 0.7,
			zoomSnap: 0.5,
			minZoom: 4.5,
			maxZoom: 6
		}).setView([40, 20], 4);
		// Some styles...
		var lndStyle = {
			"color": "#ffefdc",
			"weight": 0,
			"fillOpacity": 1.0
		};

		var wtrStyle = {
			"color": "#3BF",
			"weight": 2,
			"fillOpacity": 1.0
		};


		var polStyle = {
			"fillColor": "#F66",
			"fillOpacity": 0.3,
      "weight": 1,
      "opacity": 0.5,
      "color": "#A00"  //Outline color
		};

		/*
		var lndLyr = L.geoJSON(lnd, {
			style: lndStyle
		}).addTo(map);

		*/

		var Stamen_Watercolor = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.{ext}', {
			attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			subdomains: 'abcd',
			ext: 'png'
		}).addTo(map);

		pol = polData[267]; // polData is defined in geo/provinces.js - a JSON weird object...
		// Set Political Layer - based on pol (data) and polStyle
		var polLyr = L.geoJSON(pol, {
			style: polStyle
		}).addTo(map);

		// Set Water Layer - based on rvr (data) and wtrStyle
		/*var wtrLyr = L.geoJSON(rvr, {
			style: wtrStyle
		}).addTo(map);*/

		// All Agents
		var agents = [];
		getAgentsFromServer();

		var timeline = document.getElementById("slide");
		initBubble();
		var yearTracker = document.getElementById("yearTracker");

		var sidebar = L.control.sidebar('sidebar').addTo(map);

		var currentPopupFrame = null;
		var currentPopupName = null;
		var currentPopup = null;

		// Receive messages from other windows.
		window.addEventListener("message", receiveMessage, false);

		// Move the slide to the current year/
		updateYear();


		showUpdateAgentForm();

		function showUpdateAgentForm() {
			var temp = document.getElementsByTagName("template")[0];
			var clon = temp.content.cloneNode(true);
			document.getElementById("createAgentFormDiv").appendChild(clon);
		}

		function receiveMessage(event) {

			if (event.data == "current") {
				currentPopupFrame.contentWindow.postMessage(currentPopup.profile, '*');
			} else { // else, we're sending the name of an agent we need "to go" to.

				agent = findAgent(event.data);
				//console.log(event.data);
				//console.log(agent);
				let target = agent.marker; //findAgent(event.data).marker;
				//console.log(target);
				timeline.value = agent.profile.yearRange[0];
				updateYear(); // otherwise, it doesn't work. Needs to be on the same year.

				target.openPopup();




			}
		}

		/**
		@description Finds a match for the given agent.
 		*/
		function findAgent(name, type = 'city') {
				let match = agents.find(function(agent) {
					return agent.profile.name == name;
				});
				return match;
		}


		function getAgentsFromServer() {
			//let path = ("./agents/agents.json");
			let path = ("/agents.datastore");
			let xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {

					console.log("Server responded");
					let data = JSON.parse(this.responseText);

					addAgents(data);

					updateAgents();

					listAgents(data);
				}
			};
			xhttp.open("GET", path, true);
			xhttp.send();
		}

		function listAgents(data) {

			let agentsDropdown = document.getElementById("agentsList");
			agentsDropdown.innerHTML = ""


			data.forEach( function(element) {
				let a;


				let agentTag = `<option onclick="editAgent(this)" value="${element.name}" name="${element.name}" id="${element.id}">${element.name}</option>`

				agentsDropdown.innerHTML += agentTag;
			});

		}

		function addAgents(data) {


			data.forEach(function(element) {
				let a;

				if (element.type=='city' || element.type=='City') {
					setupCity(element);
				}else if (element.type=='person' || element.type=='Person') {
					setupPerson(element);
				}else if (element.type=='event' || element.type=='Event') {
					setupEvent(element);
				}



			});
			console.log(agents);



		}


		/**
		@description Sets up icon, popupAnchor, marker, pushes agent to Agents, and creates timeline event.
 		*/
		function setupEvent(element) {

			if (!element.iconSize){
				element.iconSize = [70,70];
			}
			if(!element.popupAnchor){
				element.popupAnchor = [0, -35];
			}

			let m = setupWithMarker(element, 20);

			let a = new Event(element.name, element.content,m,element.yearRange);

			agents.push(a);

			createTimelineEvent(a.profile.yearRange[0], element.name);

			setupWithMarker(element);
		}

		/**
		@description Sets up icon, popupAnchor, marker, and pushes agent to Agents.
 		*/
		function setupCity(element) {
			if (!element.iconSize){
				element.iconSize = [70,70];
			}
			if(!element.iconAnchor){
				element.iconAnchor = [35,60];
			}
			if(!element.popupAnchor){
				element.popupAnchor = [0, -70];
			}
			let m = setupWithMarker(element);

			let a = new City(element.name, element.content,m,element.yearRange);

			agents.push(a);
		}

		/**
		@description Sets up icon, popupAnchor, marker, and pushes agent to Agents.
 		*/
		function setupPerson(element) {

			if (!element.iconSize){
				element.iconSize = [70,70];
			}
			if(!element.iconAnchor){
				element.iconAnchor = [35,35];
			}
			if(!element.popupAnchor){
				element.popupAnchor = [0, -40];
			}

			let m = setupWithMarker(element, 10);

			let a = new Person(element.name, element.content,m,element.yearRange);

			agents.push(a);
		}

		/**
		@description .
 		*/
		function setupWithMarker(element, zOffset = 0) {
			let icon = L.icon({
				iconUrl: element.iconUrl,
				iconSize: element.iconSize,
				iconAnchor: element.iconAnchor,
				popupAnchor: element.popupAnchor
			});
			let m = L.marker(element.coordinates, {
				icon,
				zIndexOffset: zOffset
			});

			m.bindPopup((L.popup({
				lazyload: '<iframe id = "'+element.name+'" src="./agents/agent.html"></iframe>'
			})));

			/*if (element.type == 'city') {
				m.bindTooltip(element.name, { permanent: true, opacity:0.9 });
			}*/
			return m;
		}

		/*
		L.geoJSON(names, {
		}).addTo(map);
		*/
		map.on('popupopen', function(e) {

			console.log('popupopen!');
			console.log(e);
			let popen = e.popup;
			if (popen.options.lazyload) {
				popen.setContent(popen.options.lazyload);
				// *** little experiment here *************************
				console.log(popen.options.lazyload)

				//popen.setContent(popen.options.lazyload += '<div><p>Hello World</p></div>');
				// *****************************************************
				currentPopupFrame = popen._contentNode.firstChild;
				currentPopupName = currentPopupFrame.id;
				//***
				console.log(currentPopupName); // Will need this for a second.
				//***
				currentPopup = findAgent(currentPopupName);
			}
		});

		timeline.oninput = updateYear; // interesting...

		/**
		@description Updates mapYear value and calls updateAgents(). And also updates political layer.
 		*/
		function updateYear() {
			mapYear = timeline.value;
			yearTracker.innerHTML = "Year: " + mapYear + "AD";
			updateAgents();

			//remove every layer which polLyr contains from the map
			Object.keys(polLyr._layers).forEach(function(key) {
				element = polLyr._layers[key];
  			map.removeLayer(element);
			});

			//assign new GeoJSON data to pol, based on the current year
			pol = polData[mapYear]

			//if the new data is a reference to another year, use the data from that year instead
			while (typeof pol == 'number') {
				pol = polData[pol]
			}

			//recreate polLyr with the new data in pol
			polLyr = L.geoJSON(pol, {
				style: polStyle
			})

			//re-add polLyr to the map
			polLyr.addTo(map)

		}

		/**
		@description Pretty much places/remove markers depending whether the agent exists between the year range..
 		*/
		function updateAgents() {
			agents.forEach(function(a) {
				if(a.marker._latlng){
					if(a.profile.yearRange[0]<=mapYear && a.profile.yearRange[1]>=mapYear) {
						a.marker.addTo(map);
					}else{
						a.marker.remove();
					}
				}
			});
		}


		function onlyOne(checkbox) {
			var checkboxes = document.getElementsByName('check');
			checkboxes.forEach( (item) => {
				if (item !== checkbox) item.checked = false;
			});
		}










		// Called when user submits new data for updating an agent.
		function editAgent(optionTag) {


			let id = optionTag.id; // or optionTag.attributes.id
			let value = optionTag.value; // optionTag.attributes.name; (this one would have more properties attached), interesting.
			console.log("whole element");
			console.log(optionTag);
			console.log(optionTag.innerHTML);
			console.log("id");
			console.log(id);
			console.log("value");
			console.log(value);


			document.getElementById("edit.id").innerHTML = `${id}`//`(ID: ${id})`;
			document.getElementById("edit.name").innerHTML = value;

			var temp = document.getElementsByTagName("template")[0];
			temp.content.getElementById("name").value = value;

			var clon = temp.content.cloneNode(true);

			document.getElementById("editAgentFormDiv").innerHTML = "";
			// console.log(temp);
			console.log(temp.content);
			document.getElementById("editAgentFormDiv").appendChild(clon);
			// console.log(clon.content);
			// console.log(clon.innerHTML);
			// console.log(temp.getElementsByName("updateAgentForm.name"));
			//clone.("updateAgentForm.name").value = "hola";



			let path = "/readAgent.datastore/" + id;
			let xhttp = new XMLHttpRequest();
			let data = null;
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					// Do shit
					console.log("Server read agent in datastore");
					console.log(this.responseText);
					console.log(JSON.parse(this.responseText));

					let agentData = JSON.parse(this.responseText);

					temp.content.getElementById("yearRange1").value = agentData.yearRange[0] || "";
					temp.content.getElementById("yearRange2").value = agentData.yearRange[1] || "";

					console.log(temp.content.getElementById("type").selectedIndex);
					temp.content.getElementById("type").value  = agentData.type;
					let selIndex = temp.content.getElementById("type").selectedIndex;
					temp.content.getElementById("type").getElementsByTagName('option')[selIndex].selected = "selected";
					console.log(temp.content.getElementById("type"));
					console.log(temp.content.getElementById("type").getElementsByTagName('option')[0]);
					//temp.content.getElementById("type").getElementsByTagName('option')[selIndex].trigger('change');
					console.log(temp.content.getElementById("type").selectedIndex);

					if (agentData.coordinates) {
						temp.content.getElementById("coordinates1").value = agentData.coordinates[0] || "";
						temp.content.getElementById("coordinates2").value = agentData.coordinates[1] || "";
					} else {
						temp.content.getElementById("coordinates1").value = "";
						temp.content.getElementById("coordinates2").value = "";
					}

					if (agentData.content[0]) {
						temp.content.getElementById("description").value = agentData.content[0].source || "";
						temp.content.getElementById("description.att").value = agentData.content[0].att || "";

					}

					if (agentData.content[1]) {
						/*temp.content.getElementById("picture").value = agentData.content[1].source;*/
						temp.content.getElementById("picture.att").value = agentData.content[1].att || "";
					}


					temp.content.querySelector("form").id = "updateAgentForm";
					temp.content.querySelector("form").action = "/updateAgent.datastore";
					//temp.content.querySelector("form").method = "put"; cannot do put with this shit

					clon = temp.content.cloneNode(true);
					document.getElementById("editAgentFormDiv").innerHTML = "";
					document.getElementById("editAgentFormDiv").appendChild(clon);
				}
			};

			xhttp.open("GET", path, true);
			xhttp.send();


		}




		// CLASSES
		class Agent {
			constructor(name, content,type=null, yearRange=[-4000,3000]) {
				this.profile = new Profile(name,content,type,yearRange);
			}
		}

		class Profile {
			constructor(name,content,type=null, yearRange=[-4000,3000]) {
				this.name = name;
				this.content = content;
				this.type = type;
				this.yearRange = yearRange;
			}
		}

		class City extends Agent {
			constructor(name, content, marker,yearRange){
				super(name, content, 'City',yearRange);
				this.marker = marker;
			}
		}

		class Person extends Agent {
			constructor(name, content, marker,yearRange){
				super(name, content, 'Person',yearRange);
				this.marker = marker;
			}
		}

		// class Event { // shouldn't Event extend Agent?
		// 	constructor(name, content,marker,yearRange=[-4000,3000]) {
		// 		// I was wondering if the line below could be super(name,content,'Event',yearRange);
		// 		this.profile = new Profile(name,content,'Event',yearRange);
		// 		this.type = 'Event'; // doesn't profile contain an attribute for type?
		// 		this.marker = marker;
		// 	}
		// }
		class Event extends Agent {
			constructor(name, content, marker, yearRange=[-4000,3000]){
				super(name, content, 'Event', yearRange);
				this.marker = marker;
			}
		}


	// jquery code
	$(document).ready(function(){

		// The forms are useful for sending data to the server.
		// However, we want to send stuff  "in the AJAX way".
		$('#createAgentForm').submit(function(e){
			e.preventDefault();
			$.ajax({
				url:'/createAgent.datastore',
				type: 'post',
				data: $('#createAgentForm').serialize(),
				success: function(){
					// successful call
				}
			})
		});

		// because we create the updateAgentForm quite dynamically
		$('#updateAgentButton').click(function(){
			console.log("#updateAgentButton clicked");
			console.log($('#edit\\.id').text());
			console.log('/updateAgent.datastore/' + $('#edit\\y.id').text());

			$('#updateAgentForm').submit(function(e){

				e.preventDefault();

				$.ajax({
				url:'/updateAgent.datastore/' + $('#edit\\.id').text(),
				type: 'post',
				data: $('#updateAgentForm').serialize(),
				success: function(){
					// successful call
					console.log("Successful call to update method in server")
				}
				});

			});

			$('#updateAgentForm').trigger('submit');
		});



		$('#deleteAgentButton').click(function() {

			console.log("deleteAgentButton clicked");

			$.ajax({
				url: '/delAgent.datastore/' + $('#edit\\.id').text(),
				type: 'DELETE', // can't make this work with the delete method yet. Little detail, but still.
				//data: '',
				success: function() {
					// successful call
					console.log("Successful call to del method in server");
				}
			});

		});

		$('#linkAgentsButton').click(function() {
			console.log("linkAgentsButton clicked");

			$.ajax({
				url: '/linkAgents.datastore/5631986051842048/5629499534213120/undirected',
				type: 'post',
				data: '',
				success: function() {
					console.log("Successful call to link agents method in server");
				}
			});
		});


	});


	</script>



</body>

</html>
